> **v1.0, v1.3, v1.5**

**Список изменений**

Версия | Описание
--- | ---
1.5 | - При навешивании загрузчика на кнопку в `onComplete` теперь также передаётся параметр `btn`<br>- Добавлена возможность скачивать только что загруженные (временные) файлы<br>- В методе на скачивание файла появился утерянный параметр `filename`<br>- В методе прикрепления загрузчика к кнопке появился новый параметр `options` для переопределения параметров по умолчанию  
1.3 | Namespace File перенесён в Helpers

# Загрузка файлов

## JS

**v1.5**
```javascript
// Подключаем плагин загрузки файлов
var classFile = 'js-files__file';
lemurro.file.init(classFile);

// Вешаем загрузчик на кнопку
var btn = $('#js-file-upload');
var onComplete = function (fileID, fileAction, fileName, btn) {
   $('#js-files__box').append(_templates.file({
       id    : fileID,
       action: fileAction,
       name  : fileName
   }));
};
lemurro.file.bindUpload(btn, onComplete);

// Вешаем загрузчик на кнопку и переопределяем параметры по умолчанию
var options = {...};
lemurro.file.bindUpload(btn, onComplete, options);
```

**v1.0**
```javascript
// Подключаем плагин загрузки файлов
var classFile = 'js-files__file';
lemurro.file.init(classFile);

// Вешаем загрузчик на кнопку
var btn = $('#js-file-upload');
var callback = function (fileID, fileAction, fileName) {
   $('#js-files__box').append(_templates.file({
       id    : fileID,
       action: fileAction,
       name  : fileName
   }));
};
lemurro.file.bindUpload(btn, callback);
```

## HTML-шаблоны Template7

### Для коробки с файлами
```html
<div class="form-group m-form__group">
    <label>Файлы</label>
    <table class="table">
        <!-- Динамический контент -->
        <tbody id="js-files__box"></tbody>
    </table>
    <button type="button" id="js-files__upload" class="btn btn-brand btn-sm m-btn--icon">
        <span>
            <i class="fas fa-plus"></i>
            <span>Загрузить файл</span>
        </span>
    </button>
</div>
```

### Для файла
**v1.5**
```html
<tr class="js-files__file" data-file-id="{{id}}" data-file-action="{{action}}">
    <td class="align-middle">
        <a href="javascript:lemurro.file.download('{{id}}', '{{name}}');">
            <span class="js-name">{{name}}</span>
        </a>
    </td>
    <td class="w1 text-nowrap">
        <button type="button" class="btn btn-danger btn-sm m-btn--icon" onclick="lemurro.file.remove('{{id}}')">
            <span>
                <i class="far fa-trash-alt"></i>
                <span>удалить</span>
            </span>
        </button>
    </td>
</tr>
```

**v1.0**
```html
<tr class="js-files__file" data-file-id="{{id}}" data-file-action="{{action}}">
    <td class="align-middle">
        {{#js_if "this.action === 'add'"}}
        <span class="js-name">{{name}}</span>
        {{else}}
        <a href="javascript:lemurro.file.download('{{id}}');">
            <span class="js-name">{{name}}</span>
        </a>
        {{/js_if}}
    </td>
    <td class="w1 text-nowrap">
        <button type="button" class="btn btn-danger btn-sm m-btn--icon" onclick="lemurro.file.remove('{{id}}')">
            <span>
                <i class="far fa-trash-alt"></i>
                <span>удалить</span>
            </span>
        </button>
    </td>
</tr>
```

## Описание элементов шаблона
1. Обязательные переменные
  - **id** *(integer|string)* - ИД файла
    - ИД записи в БД (для ранее загруженных файлов)
    - Имя файла во временном хранилище (для новых файлов)
  - **action** *(string)* - Действие совершаемое с файлом
    - `add` - для только что загруженного файла (перенос в постоянное хранилище и запись в БД)
    - `remove` - для удаляемого файла (удаление файла и записи в БД)
    - `exist` *(или любое другое название)* - для существующего файла, файлы с действием отличным от `add` и `remove` пропускаются и не участвуют в обработке
  - **name** *(string)* - Оригинальное имя загруженного файла
3. Обязательный класс
  - **js-files__file** - Класс для элемента, который вы указали при подключении плагина
  - **js-name** - Класс для строки с оригинальным именем файла
2. Обязательные атрибуты
  - **data-file-id** - ИД файла
  - **data-file-action** - Действие совершаемое с файлом

## Логика добавления файла
1. Файл загружается и мы получаем три переменные `id`, `action` и `name`
2. Строим элемент используя эти данные

## Логика удаления файла
Удаление зависит от действия
- **action=add** - просто убираем элемент файла из DOM (физически загруженный временный файл будет удалён чистильщиком)
- **action=[ЛЮБОЕ_ДЕЙСТВИЕ_ОТЛИЧНОЕ_ОТ_ADD]** - меняем action на `remove` и визуально скрываем эелемент (сейчас файл просто помечен на удаление, физически файл будет удалён если пользователь сохранит форму)

## Собираем файлы для передачи в php
Структура массива файлов
```javascript
var files = [
    {
        file_id  : '[ИД_ФАЙЛА]',
        action   : 'add',
        orig_name: '[ИМЯ_ОРИГИНАЛЬНОГО_ФАЙЛА]'
    }, {
        file_id: '[ИД_ФАЙЛА]',
        action : 'remove'
    }, {
        file_id: '[ИД_ФАЙЛА]',
        action : 'ЧТО_ТО_ИНОЕ'
    }
];
```
- **orig_name** - Имя оригинального файла, взять из элемента `<span class="js-name">...</span>`

В простом случае это можно сделать так
```javascript
var files = [];

form.find('.js-files__file').each(function () {
    var elem   = $(this);
    var action = elem.attr('data-file-action');
    var file   = {
        file_id: elem.attr('data-file-id'),
        action : action
    };

    if (action === 'add') {
        file.orig_name = elem.find('.js-name').text();
    }

    files.push(file);
});
```

## Обработка файлов в php

### Добавление файла
```php
use Lemurro\Api\Core\Helpers\File\FileAdd;

$container_type = CONTAINER_TYPE;
$container_id = CONTAINER_ID;

$file_add = new FileAdd($this->dic);

$result = $file_add->run(
    $file['file_id'],
    $file['orig_name'],
    $container_type,
    $container_id
);
```
- **CONTAINER_TYPE** *(string, PascalCase, обязательно)* - это тип контейнера (куда был прикреплён файл), лучше всего использовать название раздела (например: `Example`), далее это слово будет использоваться для подключения класса проверки прав доступа `/app/Checker/FileExample.php`
- **CONTAINER_ID** *(integer, не обязательно)* -

\* Если вы не хотите выполнять проверку прав доступа, тогда укажите `CONTAINER_TYPE = 'Default'` и `CONTAINER_ID = null`

### Удаление файла
```php
use Lemurro\Api\Core\Helpers\File\FileRemove;

$file_remove = new FileRemove($this->dic);

$result = $file_remove->run($file['file_id']);
```

### Вот пример возможной реализации обработки
```php
use Lemurro\Api\Core\Helpers\File\FileAdd;
use Lemurro\Api\Core\Helpers\File\FileRemove;

$container_type = CONTAINER_TYPE;
$container_id = CONTAINER_ID;

$file_add = new FileAdd($this->dic);
$file_remove = new FileRemove($this->dic);

$files_ids = [];
$files_errors = [];

if (isset($data['files']) && is_array($data['files'])) {
    foreach ($data['files'] as $file) {
        switch ($file['action']) {
            case 'add':
                $result = $file_add->run(
                    $file['file_id'],
                    $file['orig_name'],
                    $container_type,
                    $container_id
                );

                if (isset($result['errors'])) {
                    $files_errors[] = array_merge($file, $result);
                } else {
                    $files_ids[] = $result['data']['id'];
                }
                break;

            case 'remove':
                $result = $file_remove->run($file['file_id']);

                if (isset($result['errors'])) {
                    $files_ids[] = $file['file_id'];
                    $files_errors[] = array_merge($file, $result);
                }
                break;

            default:
                $files_ids[] = $file['file_id'];
                break;
        }
    }
}
```
В результате вы получите 2 массива данных
- **$files_ids** - Массив ИД файлов: новых и старых
- **$files_errors** - Массив ошибок добавления \ удаления файлов

### Или можно воспользоваться фасадом
```php
use Lemurro\Api\Core\Helpers\File\FileManipulate;

$container_type = CONTAINER_TYPE;
$container_id = CONTAINER_ID;

$manipulate = (new FileManipulate($this->dic))->run(
    $data['files'],
    $container_type,
    $container_id
);
```
В результате вы получите 2 массива данных
- **$manipulate['ids']** - Массив ИД файлов: новых и старых
- **$manipulate['errors']** - Массив ошибок добавления \ удаления файлов

## Удаление файла из javascript
Если вы хотите выполнить callback-функцию после пометки файла на удаление (в качестве параметров вы получите `ИД` и `Имя` удаляемого файла)
```javascript
lemurro.file.remove(fileID, function(fileID, fileName) {
    // Ваш код
});
```

## Удаление файла из php
Если вам нужно удалить файл из php, тогда воспользуйтесь
```php
use Lemurro\Api\Core\Helpers\File\FileRemove;

$file_remove = new FileRemove($this->dic);
$result = $file_remove->run(FILE_ID);
```

## Получение информации о файлах
Для получения информации об одном файле
```php
use Lemurro\Api\Core\Helpers\File\FileInfo;

$file_id = 123;
$file_info = new FileInfo();
$array = $file_info->getOne($file_id);
```
Для получения информации о нескольких файлах
```php
use Lemurro\Api\Core\Helpers\File\FileInfo;

$file_ids = [1, 2, 3];
$file_info = new FileInfo();
$array = $file_info->getMany($file_ids);
```

## Проверка прав доступа на файл
Если вы будете использовать `container_type` отличный от `Default`, тогда вы должны создать класс для проверки прав в каталоге `/app/Checker`
```php
<?php
/**
 * Проверка прав доступа к файлу для раздела Example
 *
 * @version 08.01.2019
 * @author  Дмитрий Щербаков <atomcms@ya.ru>
 */

namespace Lemurro\Api\App\Checker;

use Lemurro\Api\Core\Helpers\File\FileChecker;

/**
 * Class FileExample
 *
 * @package Lemurro\Api\App\Checker
 */
class FileExample extends FileChecker
{
    /**
     * Проверка прав доступа
     *
     * @param string $container_id ИД контейнера
     *
     * @return boolean
     *
     * @version 08.01.2019
     * @author  Дмитрий Щербаков <atomcms@ya.ru>
     */
    public function check($container_id)
    {
        $checker_checks = [
            'role' => [
                'page'   => 'example',
                'access' => 'read',
            ],
        ];
        $checker_result = $this->dic['checker']->run($checker_checks);
        if (is_array($checker_result) && count($checker_result) == 0) {
            return true;
        } else {
            return false;
        }
    }
}
```
В данном примере просто проверяется право доступа на чтение раздела `Example`, вы можете добавить другие проверки используя полученный `$container_id`